varnishtest "Test match-global-certs config option"

# Test that match-global-certs allows frontend to use global certs for SNI

feature tls

server s1 {
	rxreq
	txresp
} -start

# Config with match-global-certs enabled
shell {
cat >${tmpdir}/vtls.cfg <<EOF
  # Global certificate
  pem-file = "${topsrc}/etc/ca/bundle/no-san.example.com.pem"

  frontend = {
      host = "${localhost}"
      port = "0"
      match-global-certs = on
      sni-nomatch-abort = on
  }
EOF
}

varnish v1 -arg "-A ${tmpdir}/vtls.cfg" -vcl+backend {} -start

# The frontend has no local certificates but match-global-certs is enabled
# so it should use the global certificate for SNI matching
client c1 {
	tls_config {
		servername = no-san.example.com
	}
	tls_handshake
	expect tls.failed == false
	expect tls.cert.subject == "no-san.example.com"
} -run
