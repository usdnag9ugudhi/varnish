varnishtest "Test ssl_verify_host"

# Create CA certificate and server certificate bundle
shell {
cat > ${tmpdir}/ca.pem <<EOF
-----BEGIN CERTIFICATE-----
MIIF+zCCA+OgAwIBAgIUPPYROO38cKH583jxfOhQcHW7Yi8wDQYJKoZIhvcNAQEL
BQAwgYQxCzAJBgNVBAYTAk5PMQ8wDQYDVQQIDAZOb3J3YXkxGTAXBgNVBAoMEFZh
cm5pc2ggU29mdHdhcmUxITAfBgNVBAsMGFZhcm5pc2ggU29mdHdhcmUgVGVzdCBD
QTEmMCQGA1UEAwwdVmFybmlzaCBTb2Z0d2FyZSBUZXN0IFJvb3QgQ0EwHhcNMjEw
OTE0MDgzNjQ1WhcNNDIwMzI4MDgzNjQ1WjCBhDELMAkGA1UEBhMCTk8xDzANBgNV
BAgMBk5vcndheTEZMBcGA1UECgwQVmFybmlzaCBTb2Z0d2FyZTEhMB8GA1UECwwY
VmFybmlzaCBTb2Z0d2FyZSBUZXN0IENBMSYwJAYDVQQDDB1WYXJuaXNoIFNvZnR3
YXJlIFRlc3QgUm9vdCBDQTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIB
AMH8ASVHrfdwmX7I8L56NdXCuPbCxJRe9Emnn1kJvDLDzErkLhcyTqTwRdVomrHC
VeiVFA28Uj2n+J00HXQEPhmcaskbydTFUPwxeWPctJ472tdIJ84f7mewlj+0bnXh
+fuGEYB7F9GSHlkK9HH53wzT+oSZJBEnKe8aXDlm/9tQTbA2cnoEUcyMlOWQzrTD
OtbxsYdus0pzc1g8CAbfyHbc0h4TW+wl6DvN+AK8opy1EAPbKif8ug+QTaHL9uAE
/dPjrob0o3Oqa+eaXl3U6lx5KlCR0KKcfuj7cNVIX4BE3FVEYfznp9p/P1AK8oME
ZNGW1sXS64BnM8/9Op/OjQznfQ94dtrquFDvB9Cswn9IlPYjJRjDTcvXnlGP0rHv
uHCRhf2WWzhiAS/Pu29m614Gtdu8JhJVB+mo+sCq4M+O0KeUB6CWh+T/mSbZmN4i
58OzJQe9YANzUsaytQxbeeK9EP3DLWaOp7RVJpIn5mxoyK5wwTYDFkcxJnjBULDQ
XTer1zXJQsgXb+NN2zX6OG2R4PmxaNjztqmYbNyE0WjOHiB3/hQGBelmYFJ602QZ
InZNwuJgMWNw6T7rwptw/G7VqJwdlsKKr/ih0WNi6U1vBZCfqYhe2HWhAvWAu96C
JNFgCWT69VmLC0cBbpI38LHzDLoGxQm2kXyVmPwPl5bXAgMBAAGjYzBhMB0GA1Ud
DgQWBBRyuBogtm++xwNjdhOPJVyTqMD1ZjAfBgNVHSMEGDAWgBRyuBogtm++xwNj
dhOPJVyTqMD1ZjAPBgNVHRMBAf8EBTADAQH/MA4GA1UdDwEB/wQEAwIBhjANBgkq
hkiG9w0BAQsFAAOCAgEAHfRyTqIbw0YFFj7S0whRhjihjEDHtE2M+nDmClJK82Wp
fwiGj1Fn74plGveUKLaFiUl4ZtB70MSTgDzaMJUfc7Vx/jvtoWZexVE0NpgF9YOZ
dZD0qhO/9I/kZe8/adELrxXaHbKLdqMETeRDT+TvP2k3+oaRz3CqdkbXXi0G6mHT
LnmYE7B+KNC5KhHgegpsnHEkloIX7ZK/awcDgZ1cFbntcTQKrqBkyvXCFnt9Nxqa
9+UD7vjbjSdPDWkD54Kkc6oERMoZwEZRfQtYXtm2bOhS+JrNm2UrCRXPXa0ijTjU
2/UUSJFCQMFLSe8raOcm2lesWGYj2TeobHPPzEvsBQlM4Bg1TPFkmqdeHDIy22+k
E+gdwwkK/Nt+gy60fEHG9n7ogWlBy9gK6lUtP/8plyNhG3nPneBPz84HdhvnInsI
9NNjdDehYPjL0Wbg5qPfCmk32w1q7bhVfGlop1Y3OUIvOQYcr5JA8roHYuHoyz05
HOg5LXoMKkH6exrxlbpsA4Eu37s70R3nRXGag4h5kKIYxoSi6rAIYlG6JZTTYIiJ
/kJDeh7cRlYR9qWAzvcKuR7US1yEDBXH2A1MreFwoqgXj5VvgJ70MW8OeIfMVHDT
O5RaN8Lt+/bG6EQFYIrLAYuByx3qKwhjfW4ndSE6XqAyMNSOErd6XySqPiSlc1A=
-----END CERTIFICATE-----
EOF

cat > ${tmpdir}/example.com.pem <<EOF
-----BEGIN CERTIFICATE-----
MIIGDzCCA/egAwIBAgICEAowDQYJKoZIhvcNAQELBQAwgYwxCzAJBgNVBAYTAk5P
MQ8wDQYDVQQIDAZOb3J3YXkxGTAXBgNVBAoMEFZhcm5pc2ggU29mdHdhcmUxITAf
BgNVBAsMGFZhcm5pc2ggU29mdHdhcmUgVGVzdCBDQTEuMCwGA1UEAwwlVmFybmlz
aCBTb2Z0d2FyZSBUZXN0IEludGVybWVkaWF0ZSBDQTAeFw0yNDExMjAxMjQ1MDla
Fw00NTA2MDMxMjQ1MDlaME8xCzAJBgNVBAYTAk5PMQ8wDQYDVQQIDAZOb3J3YXkx
GTAXBgNVBAoMEFZhcm5pc2ggU29mdHdhcmUxFDASBgNVBAMMC2V4YW1wbGUuY29t
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA78M4AgyEzp7866Yn3lGi
wSXEa6XvS+kL2irVm71zGzlwKe3rcp/J/Vr715eaO1GHh1GQhKhQ0nTEHe87mPU4
hOskwL2f+g3pkvw7iwmpf6whuA1GalX3Q5uN6xkqEIoTWQdhng1y4JNH+6NER/SX
dSycRqWNuF2xfKM0TVxvBKUc6FcvZPyoqfvDBhdHjCUW9ZQm01oECMDUpEwojLy4
A7EID01M4P60L5tjYWuTeIXDXTwd5C5IaCjAF8YCRK1W6v44n9MAJcW9wdSTK3R8
y1gQKTxKpA0DuTNlcDjX+CEhyWr5zOrXAhYlv5qNqo3w/u207NVTMB5wAXO9QjNc
QQIDAQABo4IBtTCCAbEwCQYDVR0TBAIwADARBglghkgBhvhCAQEEBAMCBkAwMwYJ
YIZIAYb4QgENBCYWJE9wZW5TU0wgR2VuZXJhdGVkIFNlcnZlciBDZXJ0aWZpY2F0
ZTAdBgNVHQ4EFgQUqutqU1oLqE5CeSi3F1Gjo9VJB7AwgbIGA1UdIwSBqjCBp4AU
KxxDAoAYRQhoXWowfObwwY9+/gOhgYqkgYcwgYQxCzAJBgNVBAYTAk5PMQ8wDQYD
VQQIDAZOb3J3YXkxGTAXBgNVBAoMEFZhcm5pc2ggU29mdHdhcmUxITAfBgNVBAsM
GFZhcm5pc2ggU29mdHdhcmUgVGVzdCBDQTEmMCQGA1UEAwwdVmFybmlzaCBTb2Z0
d2FyZSBUZXN0IFJvb3QgQ0GCAhAAMA4GA1UdDwEB/wQEAwIFoDATBgNVHSUEDDAK
BggrBgEFBQcDATAtBgNVHREEJjAkggtleGFtcGxlLmNvbYIPd3d3LmV4YW1wbGUu
Y29thwQBAgMEMDQGCCsGAQUFBwEBBCgwJjAkBggrBgEFBQcwAYYYaHR0cDovL29j
c3AwLmV4YW1wbGUuY29tMA0GCSqGSIb3DQEBCwUAA4ICAQAjPoqDWwzPTO328n80
+fKq97+sCz3M+Ywubwq+V7Ht7bGntNSHQ4cfrURxBJhZo6URBFkZwpwpOtw9fzWP
p+vQz1O3m8rPeMHj//7sWDjPjPkB7ZU8X0TDcsh3gnDr2noqZiqOaD56ETiO+O5j
BcpVD31PnBkxpMz1BAhFoHxIbx+sourQVLGMii31cYcwGoCV6xMN6b6IXA+P0CBt
PLRWx5rAt+qLeFmUTvOOVz1E7Y2zkjB9QolSx/+ezlBkXcyH430FcDfe8B3deROM
iw6z84VVKhH35rYKODxPmHCWsUdXLpj37fZZQ1u/+aW7LpajrhwgY2BpPD6lEgXw
tgmDtOTEXUFhHvLLgmjXFSeJMkVIxms4cSx8RLdeMxBASoPKCJnXYqJ4KJLPdGQi
s388GC/aG4LVExOwmuuD7rUWzrRTsE3vxB6lGTOeF5LJG4XusZPDjQ543WvQK0Mh
3xboN9yJj2GxVa9VKzogwo9jFuCjZf42cEFGRfWDOevEdlNLB8/mYHt+Qf08aoNJ
LhI/qsRORhkTTASB4ceMyFy+TKiW2k/r4CeQwcOTnW++Uc/oBAueURParuVpk3Tw
q/0wNwaE5Bq9uF3pleNlGe9VVuWTw7xylnAJOvBV37fPn3IZLIRmdIsvt+On3Wlz
ONAuc3QKuIzdZwJiKDXQ76zZbQ==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIF9DCCA9ygAwIBAgICEAAwDQYJKoZIhvcNAQELBQAwgYQxCzAJBgNVBAYTAk5P
MQ8wDQYDVQQIDAZOb3J3YXkxGTAXBgNVBAoMEFZhcm5pc2ggU29mdHdhcmUxITAf
BgNVBAsMGFZhcm5pc2ggU29mdHdhcmUgVGVzdCBDQTEmMCQGA1UEAwwdVmFybmlz
aCBTb2Z0d2FyZSBUZXN0IFJvb3QgQ0EwHhcNMjEwOTE0MDg0NjEzWhcNNDIwMzI4
MDg0NjEzWjCBjDELMAkGA1UEBhMCTk8xDzANBgNVBAgMBk5vcndheTEZMBcGA1UE
CgwQVmFybmlzaCBTb2Z0d2FyZTEhMB8GA1UECwwYVmFybmlzaCBTb2Z0d2FyZSBU
ZXN0IENBMS4wLAYDVQQDDCVWYXJuaXNoIFNvZnR3YXJlIFRlc3QgSW50ZXJtZWRp
YXRlIENBMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAzWmSkCI6bqe3
9SrdwQZ/W884jljIF1kRpu/seLJjjOzQBh8oCWh0gmWtStibIf5vNx5VBoQdmQ5f
vbFbaeiXPLRzSg3p0UypYC8z4J/7s8aW5OAbR6dOYv3HOIhnDWCw/B/FyCnXNpDx
bscH78Ikh30JRYwCToNSs5aM0pBVrkm/qS7NvMZot3If5Hhs76Ow6h2t3iaRGVa6
L0lVqvf/bRt8rv+M2SFNyKUzatLb7MchepPVBNLL+GWAScv/Vwe9RatBUBIuCtun
SyJVWmwvkDQmNKkBlM+jQQnIxGesCZp9GrFtduaMOCFW6NvSa+vaiPRGUMSF+jZd
j0bJHZPmDIob//2R2HWst1N6Hiy4DKD1uesqScqqCHlP4rOjlVfO4c/TBz1HuLqy
oHxKErR/ftWGTLXgCCaZW/w6nzwqctQprdzO5glnvBdat8YWwuJTGsiCNWIBtAG4
Qnxj0E/vnUPt8ZNTdMKrP0gUqCr6syIJDhHAD3YvlrC8hzNt19tSFIYNFNVXgc8v
6uxG3OoC6dH9hFOfpIvrcmjMj9sS/FeCnUthLYGx2tclCpMaTfJI9szXin64PPTP
H0ULNmrVBUtzyeA2Y/UG0XqxxPTDsjyE/Nd5n2nZ814memhEaJ1+ocvolUDezeIy
KwziP0ShVjP8vfDbmYTgeWQDyndjOaUCAwEAAaNmMGQwHQYDVR0OBBYEFCscQwKA
GEUIaF1qMHzm8MGPfv4DMB8GA1UdIwQYMBaAFHK4GiC2b77HA2N2E48lXJOowPVm
MBIGA1UdEwEB/wQIMAYBAf8CAQAwDgYDVR0PAQH/BAQDAgGGMA0GCSqGSIb3DQEB
CwUAA4ICAQCLgSkGyw1cNeDTNta/6a0u1oDOk9u/r3R35pNVsoza3cULAAKTLGVO
QT/kRvEd0aKkp3TsXukzRb99f3/80bmKZ0hsrrSQcjV9xMXksUWB2UhjkQxR9H8b
SZaqZQqn2KoTO0hJedvn6FTxtynDDdEGrFPVPRKq3HZ+FB9UTv7ZaZNWbVtCpK4V
EDp+tl2Oo67fauWIH5DhNqZBIJc7Y1rp8lNnwXQLKvZu5nid47zInwWLcDUVXpqi
FqaE7V7tFxozLI99jb1pjND7VPSnOYyfMcem2Nj0cxexyszBQXFC7yQJ7woVSDSp
VYB6R24kqFFmFlYdmx+pGRpYgikzB0hqSg/PxG90DDwVD/VxZBoNqOK3BkQAe91Q
p9oQhARSBo1xbsRu2tFl3vSWa0vCITqS3nVPKuR5pZwUJoGUQlDEgXeMzeZAuQVC
D6yaw6GZuGklPgpJzhNAsXpC2nKt92YXwL6nb94hTlAtBgMo5hF4Qmb8qQ2e3GCQ
VYFNCPZW+LoDh17nHLpra4g7vce5VE+lGjAKX3AfVntDrdRdQLbnLnMlbKvs3dwo
s73PwaH5/1VOQYzIqP0VHIZhnOWh7t2GTLEdQq24+FFu+RBdNlKE9EDKveXBxqK/
AMaUSLvXIwj71yKit+qew7Qqu596bAnXteQLx33uMMSuo8Dl1eRC7w==
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEA78M4AgyEzp7866Yn3lGiwSXEa6XvS+kL2irVm71zGzlwKe3r
cp/J/Vr715eaO1GHh1GQhKhQ0nTEHe87mPU4hOskwL2f+g3pkvw7iwmpf6whuA1G
alX3Q5uN6xkqEIoTWQdhng1y4JNH+6NER/SXdSycRqWNuF2xfKM0TVxvBKUc6Fcv
ZPyoqfvDBhdHjCUW9ZQm01oECMDUpEwojLy4A7EID01M4P60L5tjYWuTeIXDXTwd
5C5IaCjAF8YCRK1W6v44n9MAJcW9wdSTK3R8y1gQKTxKpA0DuTNlcDjX+CEhyWr5
zOrXAhYlv5qNqo3w/u207NVTMB5wAXO9QjNcQQIDAQABAoIBAQCSmrL/hbobQVnz
mWidZxt2sOo2zILSztAhebmdfi0JA4kTCljCgPQYh+6gOCHljYeqdXRBuU2aMi3N
BABUGfWSSNnzRL+yPZmJ99NMw/6xg4YmrW9WC/SikVYo3/05mcQU1w+Yfi61JTmJ
o55XxTZrPnjcNdS/XALv7DdJ6nAzzLcvhFGNIYiJ1trelRDYOp91aS+UcWX5H00n
cwqRuu8Bd+f1w+D+zea/InjKtlQG91PHx+cKqnqE/bthQbBTwUN1vSgu136pK7Wh
ornDqLuzlyqNbtgwZFS1R6rGh6It6Fvuam4++bCnr0vX/h7IehOMwzyZcr4Brm5W
FeNCZvOlAoGBAPoAytwoMPaHe8MccBx+EoAPyVXyhcQFegWW8VpW3LmIc+6z9Qo1
kGlvmCLzLvqO5UayzZmXkjvyFoQP2M1UQTuO8Q3BKn7RNawqhCmftzYS/uVL8aWr
77Zn4eUVJK4f2v14lMbbNrFPZNiCJD7dhvjdKVxQtBsltmIQNRY3IYlvAoGBAPWD
irVdrQpRKhDIEeU9xXislkCyHH4+pEZcx5rwZ6o6uS7223CuNd3cTIN+hrXK278x
eHIGZFj4rEFJ5GS/JS6gddJfQE7iPBHWh+YcEwmU5NQU1Evh3EzNfHTMSlNfOWky
QN+pw9bh9dHXTnCKUI5wFUCNq7caIBiYRds6Tb1PAoGBAM2ehTqZ29uIBySsaREm
J/UoBsIn3BkjH/8k7JEOzC/UqPV1EV86OvJdFFX6iXMOwEhrm2puHZosPJSVrA0E
9ToVEPHtJBR14Z0ewuCxOjDBYuAYnEFUrq3ptwOBZk/IZ4b9+++qMMuYryrbrw/9
h5t72x7QSbHiTKVPCzqgUXcFAoGAOLDoLZr04wX83aUlJLcPyx6nD0dRdwFF841m
9er/NPqcWjDcWPeRLqq47EAiIQY3mb11n3bEYxsAw46pc24DyvF4Y1xlQBHTZxcP
iF4BM1wzPpmUr/T2ZrGoRFwL6ZZ6bkURX9QWiZ7hoVPDJA98LHfLIH3WIdChiqxW
rRmYa9cCgYEAvQSkToou2sPxKen6XVxSOSBO8OWD9yN6T21bl3Pc0xD4OlRLNU8U
hqDeRSBBOS7TqFBHE/XPrOrfb2JkSscT76+KA6i2vpd1M2OeyQ9pbXNpN0ApFT1J
gxR5R3rlkGa2vHurBnwdkYowNAPfgAluzHTsoRQk3KnK6EQPn0xqFyg=
-----END RSA PRIVATE KEY-----
EOF
}

# Tell OpenSSL to use our CA certificate
setenv SSL_CERT_FILE ${tmpdir}/ca.pem

# Test: ssl_verify_host should fail when host_header doesn't match certificate CN
# Certificate is for example.com, but host_header is "foo"
server s1 {
	tls_config {
		cert = ${tmpdir}/example.com.pem
	}
	tls_handshake
	expect tls.failed == true
} -start


varnish v1 -vcl {
	backend default {
		.host = "${s1_addr}";
		.port = "${s1_port}";
		.host_header = "foo";
		.ssl = 1;
		.ssl_verify_host = 1;
	}
} -start

logexpect l1 -v v1 {
	expect * 1002	BackendSSL	"Server verification failed"
} -start

client c1 {
	txreq -url "/"
	rxresp
	expect resp.status == 503
} -run

logexpect l1 -wait

# Test: ssl_verify_host should succeed when host_header matches certificate SAN
# Certificate has SAN entries for example.com, www.example.com, and IP 1.2.3.4
server s2 {
	tls_config {
		cert = ${tmpdir}/example.com.pem
	}
	tls_handshake
	expect tls.failed == false
	rxreq
	txresp -body "OK"
} -start

varnish v1 -vcl {
	backend default {
		.host = "${s2_addr}";
		.port = "${s2_port}";
		.host_header = "example.com";
		.ssl = 1;
		.ssl_verify_host = 1;
	}
}

client c1 {
	txreq -url "/success"
	rxresp
	expect resp.status == 200
	expect resp.body == "OK"
} -run

# Test: ssl_verify_host should also succeed with www.example.com (another SAN entry)
server s3 {
	tls_config {
		cert = ${tmpdir}/example.com.pem
	}
	tls_handshake
	expect tls.failed == false
	rxreq
	txresp -body "WWW OK"
} -start

varnish v1 -vcl {
	backend default {
		.host = "${s3_addr}";
		.port = "${s3_port}";
		.host_header = "www.example.com";
		.ssl = 1;
		.ssl_verify_host = 1;
	}
}

client c1 {
	txreq -url "/www"
	rxresp
	expect resp.status == 200
	expect resp.body == "WWW OK"
} -run
