varnishtest "Test sni-nomatch-abort config option"

# Test that sni-nomatch-abort config option aborts connection
# when SNI doesn't match any certificate

feature tls

server s1 {
	rxreq
	txresp
} -start

# Config with sni-nomatch-abort enabled
shell {
cat >${tmpdir}/vtls.cfg <<EOF
  frontend = {
      host = "${localhost}"
      port = "0"
      sni-nomatch-abort = on
  }
EOF
}

varnish v1 -arg "-A ${tmpdir}/vtls.cfg" -vcl+backend {} -start

# Load a certificate
varnish v1 -cliok "tls.cert.load testcert ${topsrc}/etc/ca/bundle/no-san.example.com.pem"
varnish v1 -cliok "tls.cert.commit"

# Connection with matching SNI should succeed
client c1 {
	tls_config {
		servername = no-san.example.com
	}
	tls_handshake
	expect tls.failed == false
	expect tls.cert.subject == "no-san.example.com"
} -run

# Connection with non-matching SNI should fail because sni-nomatch-abort is on
client c2 {
	tls_config {
		servername = nonexistent.example.com
	}
	tls_handshake
	expect tls.failed == true
} -run
